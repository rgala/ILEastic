## OpenAPI Static

This plugin provides tools and an ILEastic plugin to add an OpenAPI documentation
to an ILEastic web service by adding the plugin and a generated ILE module to the 
ILE program.

An OpenAPI enabled ILE program consists of the following ILE modules:
- application (main module)
- OpenAPI ILEastic plugin
- OpenAPI document (generated)
- OpenAPI init module

The OpenAPI ILEastic plugin (module OPENAPI) and OpenAPI init module (module 
OPENAPIINI) are provided by this ILEastic plugin project.

The OpenAPI document module source (OPENAPIDOC) will be generated by the provided 
commands, see below section "Provided OpenAPI document".


### Prerequisites

This README assumes that ILEastic and the OpenAPI static plugin has been build
successfully.


### Provided OpenAPI document

If the OpenAPI spec is already fully available (f. e. developed with an OpenAPI 
editor) and placed on the IFS as a stream file it can be directly used to generate
an ILE module with the OpenAPI spec as the content of the module. The ILE module
is generated with the command OAPIMODGEN. OAPIMODGEN will create the source
code for the ILE module. This can be compiled with a simple CRTRPGMOD command call.

```
OAPIMODGEN 
    TMPLDIR('/path/to/ileastic/plugins/openapi-static/templates') 
    DOCPATH('/path/to/provided/openapi-spec.yaml') 
    MODPATH('/tmp/openapi-generated.rpgmod')

CRTRPGMOD MODULE(OPENAPIDOC) SRCSTMF('/tmp/openapi-generated.rpgmod')
```

The steps for embedding OpenAPI into the ILEastic application:

1. Build the application module
2. Put the OpenAPI document in the IFS
3. Generate the OpenAPI source document with the command OAPIMODGEN
4. Compile the OpenAPI source document with CRTRPGMOD with the module name OPENAPIDOC
5. Build the ILE program object including the modules of the application, 
   OPENAPIDOC, OPENAPIINI and OPENAPI

Note: The OpenAPI document stream file needs to have the CCSID 1252 and the content
      of the stream file should also be in CCSID 1252.

Note: The modules `OPENAPI`, `OPENAPIDOC` and `OPENAPIINI` _must_ be bound statically 
      to the program as does the generated OpenAPI document module.


### Embedded OpenAPI spec in source

The OpenAPI spec can also be embedded into the source code, see 
[examples/openapi-multiple-sections.rpgle](https://github.com/sitemule/ILEastic/blob/master/plugins/openapi-static/examples/openapi-multiple-sections.rpgle).

The different sections are marked with corresponding identifiers in the comments.

- @openApiPath : OpenAPI paths section
- @openApiComponent : OpenAPI components section
- @openApi : For everything that does not go into the paths or components section

The OpenAPI spec needs to be embedded in YAML format as a comment.

```
//
// @openApiPath
//
//  /champion:
//    get:
//      tags:
//        - champion
//      summary: List IBM champions
//      description: Returns the details of all awarded IBM champions
//
```

The command OAPISRCGEN extracts the OpenAPI spec from the source code and puts
it all into one stream file. Multiple stream files can be specified on the command
call.

```
OAPISRCGEN 
    INPATH('/usr/local/src/ileastic-openapi/plugins/openapi-static/examples/openapi-multiple-sections.rpgle' 
           '/home/mihael/src/ileastic-openapi/plugins/openapi-static/examples/openapi-path-only.rpgle')
    DOCPATH('/tmp/openapi-generated.yaml')                                         
```

From then on the workflow from "Provided OpenAPI document" can be followed as a 
full OpenAPI document is now available as a stream file.


### Adding OpenAPI Route

First the copy book of this plugin needs to be added.

```
/include 'ileastic/plugins/openapi-static/openapi.rpginc'
```

Then the route to the OpenAPI end point needs to be added.

```
il_addRoute(config : %paddr('ileastic_openapi_static') : IL_GET : '/openapi');
```


### Content-Type

By default the OpenAPI plugin will provide the content with the HTTP header
`Content-Type : application/openapi+yaml`.

The content type can also be configured by call `ileastic_openapi_setContentType`
if a different content type is needed.

```
ileastic_openapi_setContentType('application/yaml');
```


### Limitations

Currently this plugin only supports characters from the CCSID 1252 
(Latin 1 / ISO-8559-1) character set.
